version: "3.9"

services:
  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: notification_rabbitmq
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - notification_network

  # PostgreSQL for User Service
  postgres_user:
    image: postgres:15-alpine
    container_name: notification_postgres_user
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: user_service
      POSTGRES_PASSWORD: ${POSTGRES_USER_PASSWORD:-userpass123}
    ports:
      - "${POSTGRES_USER_PORT:-5432}:5432"
    volumes:
      - postgres_user_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user_service -d user_db"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - notification_network

  # PostgreSQL for Template Service
  postgres_template:
    image: postgres:15-alpine
    container_name: notification_postgres_template
    environment:
      POSTGRES_DB: template_db
      POSTGRES_USER: template_service
      POSTGRES_PASSWORD: ${POSTGRES_TEMPLATE_PASSWORD:-templatepass123}
    ports:
      - "${POSTGRES_TEMPLATE_PORT:-5433}:5432"
    volumes:
      - postgres_template_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U template_service -d template_db"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - notification_network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: notification_redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - notification_network

  # User Service
  user_service:
    build:
      context: .
      dockerfile: ./services/user_service/Dockerfile
    container_name: notification_user_service
    ports:
      - "${USER_SERVICE_PORT:-8001}:8000"
    environment:
      DATABASE_URL: postgresql://user_service:${POSTGRES_USER_PASSWORD:-userpass123}@postgres_user:5432/user_db
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
    depends_on:
      postgres_user:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - notification_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Template Service
  template_service:
    build:
      context: .
      dockerfile: ./services/template_service/Dockerfile
    container_name: notification_template_service
    ports:
      - "${TEMPLATE_SERVICE_PORT:-8004}:8000"
    environment:
      DATABASE_URL: postgresql://template_service:${POSTGRES_TEMPLATE_PASSWORD:-templatepass123}@postgres_template:5432/template_db
      REDIS_URL: redis://redis:6379/1
    depends_on:
      postgres_template:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - notification_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Email Service
  email_service:
    build:
      context: .
      dockerfile: ./services/email_service/Dockerfile
    container_name: notification_email_service
    ports:
      - "${EMAIL_SERVICE_PORT:-8002}:8000"
    environment:
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379/2
      TEMPLATE_SERVICE_URL: http://template_service:8000
      USER_SERVICE_URL: http://user_service:8000
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@example.com}
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      template_service:
        condition: service_healthy
      user_service:
        condition: service_healthy
    networks:
      - notification_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Push Service
  push_service:
    build:
      context: .
      dockerfile: ./services/push_service/Dockerfile
    container_name: notification_push_service
    ports:
      - "8003:8000"
    environment:
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379/3
      TEMPLATE_SERVICE_URL: http://template_service:8000
      USER_SERVICE_URL: http://user_service:8000
      FCM_PROJECT_ID: ${FCM_PROJECT_ID:-}
      FCM_SERVICE_ACCOUNT_PATH: /app/notification-service-d10e6-c3b98cba24f9.json
    volumes:
      # Mount Firebase JSON (locally and in CI)
      - ./notification-service-d10e6-c3b98cba24f9.json:/app/notification-service-d10e6-c3b98cba24f9.json:ro
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      template_service:
        condition: service_healthy
      user_service:
        condition: service_healthy
    networks:
      - notification_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3


  # API Gateway
  api_gateway:
    build:
      context: .
      dockerfile: ./services/api_gateway/Dockerfile
    container_name: notification_api_gateway
    ports:
      - "${API_GATEWAY_PORT:-8000}:8000"
    environment:
      DATABASE_URL: postgresql://user_service:${POSTGRES_USER_PASSWORD:-userpass123}@postgres_user:5432/user_db
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379/4
      USER_SERVICE_URL: http://user_service:8000
      TEMPLATE_SERVICE_URL: http://template_service:8000
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
    depends_on:
      postgres_user:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      user_service:
        condition: service_healthy
      template_service:
        condition: service_healthy
    networks:
      - notification_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  rabbitmq_data:
  postgres_user_data:
  postgres_template_data:
  redis_data:

networks:
  notification_network:
    driver: bridge
